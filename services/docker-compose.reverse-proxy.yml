version: '3.4'
services:
    reverse-proxy:
        image: traefik:${DOCKER_TRAEFIK_VERSION}
        #container_name: reverse-proxy
        container_name: "traefik"
        restart: unless-stopped
        hostname: reverse-proxy.${DOMAINNAME}
        #healthcheck
        ports:
            - "80:80"
            - "443:443"
            # Web UI
            - "8081:8080"
        env_file:
            - docker-compose.base.env
        environment:
            TRAEFIK_API_INSECURE: "true"
            TRAEFIK_PROVIDERS_DOCKER: "true"
            TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT: "false"
            TRAEFIK_ENTRYPOINTS_WEB_ADDRESS: ":80"
            TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_TO: "websecure"
            TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_SCHEME: "https"
            TRAEFIK_ENTRYPOINTS_WEBSECURE_ADDRESS: ":443"
            TRAEFIK_PROVIDERS_FILE_DIRECTORY: "/etc/traefik/"
            TRAEFIK_PROVIDERS_FILE_WATCH: "true"
            #TRAEFIK_ACCESSLOG: "true"
            #TRAEFIK_LOG_LEVEL: "DEBUG"
        #     - DEFAULT_HOST=${DOMAINNAME}
        secrets:
            - source: lum_ssl_key
              target: /etc/traefik/certs/lum.key
            - source: lum_ssl_crt
              target: /etc/traefik/certs/lum.crt
            - source: paperless_ssl_key
              target: /etc/traefik/certs/paperless.key
            - source: paperless_ssl_crt
              target: /etc/traefik/certs/paperless.crt
            - source: e3w_ssl_key
              target: /etc/traefik/certs/e3w.key
            - source: e3w_ssl_crt
              target: /etc/traefik/certs/e3w.crt
            - source: metabase_ssl_key
              target: /etc/traefik/certs/metabase.key
            - source: metabase_ssl_crt
              target: /etc/traefik/certs/metabase.crt
            - source: db-admin_ssl_key
              target: /etc/traefik/certs/db-admin.key
            - source: db-admin_ssl_crt
              target: /etc/traefik/certs/db-admin.crt
            - source: home_ssl_key
              target: /etc/traefik/certs/home.key
            - source: home_ssl_crt
              target: /etc/traefik/certs/home.crt
            - source: ldap-admin_ssl_key
              target: /etc/traefik/certs/ldap-admin.key
            - source: ldap-admin_ssl_crt
              target: /etc/traefik/certs/ldap-admin.crt

        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./conf/reverse-proxy/certificates.toml:/etc/traefik/certificates.toml
        networks:
            podewitz_local_net:
                aliases:
                    - reverse-proxy.${DOMAINNAME}
                ipv4_address: 172.25.0.7

